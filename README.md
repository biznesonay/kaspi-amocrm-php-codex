# Kaspi → amoCRM (PHP 8.1+, MariaDB 10.6 / PostgreSQL 9.2)

Функциональная интеграция: каждые **1 минуту** создаёт сделки из новых заказов Kaspi, каждые **10 минут** сверяет изменения. Контакты ищутся/создаются по **телефону (E.164)**, товары добавляются как **элементы каталога** amoCRM и привязываются к сделке. Присутствует антидубли по `order.code` и водяные знаки (watermark).

## Установка (без SSH, типичный shared-хостинг)

1. **Создайте БД** (MariaDB 10.6 *или* PostgreSQL 9.2).  
2. **Скачайте ZIP** из этого архива и загрузите папку на хостинг (например, в `/kaspi-amocrm`).  
3. **Скопируйте `.env.example` → `.env`** и заполните параметры (БД, токены, ID воронки/статуса/ответственного, каталог).  
4. **Запустите миграции** открыв в браузере:  
   `https://ВАШ_ДОМЕН/ПУТЬ/public/migrate.php?token=CRON_SECRET_из_env`  
5. **OAuth amoCRM**: включите интеграцию в аккаунте amoCRM, укажите Redirect URI на
   `https://ВАШ_ДОМЕН/ПУТЬ/public/oauth_callback.php`. После подтверждения прав токены сохранятся в БД.
   На старте можно временно вставить ACCESS/REFRESH в `.env` — сервис сам перенесёт их в БД
   (и больше не будет трогать, когда запись в `oauth_tokens` уже создана).
6. **Cron в панели хостинга**:
   - Каждую минуту: `php /путь/к/проекту/bin/fetch_new.php`
     или по HTTP: `https://ВАШ_ДОМЕН/ПУТЬ/public/cron.php?task=new&token=CRON_SECRET`
   - Каждые 10 минут: `php /путь/к/проекту/bin/reconcile.php`
     или по HTTP: `https://ВАШ_ДОМЕН/ПУТЬ/public/cron.php?task=reconcile&token=CRON_SECRET`
   - **Для серверов с Supervisor/systemd есть более удобный вариант — см. раздел «Cron» ниже.**

## Настройки

- **AMO_PIPELINE_ID / AMO_STATUS_ID / AMO_RESPONSIBLE_USER_ID** — куда класть сделки.
- **AMO_CATALOG_ID** — каталог товаров amoCRM. Позиции будут создаваться/переиспользоваться и привязываться к сделке.
- **AMO_LEAD_ORDER_CODE_FIELD_ID (опц.)** — ID пользовательского поля «Order Code» на сделке.
- **AMO_CONTACT_ADDRESS_FIELD_ID (опц.)** — ID пользовательского поля контакта для адреса доставки.
- **AMO_LEAD_DELIVERY_ADDRESS_FIELD_ID (опц.)** — ID пользовательского поля сделки для адреса доставки.
- **AMO_LEAD_ORDER_DATE_FIELD_ID (опц.)** — ID пользовательского поля сделки для даты заказа (ISO 8601).
- **DEFAULT_COUNTRY** — по умолчанию `KZ` для нормализации телефонов.

## Готовность к запуску

- Убедитесь, что `.env` заполнен, а секреты (OAuth и Kaspi) **не хранятся в публичных директориях**.
- После успешных миграций проверьте, что в БД появилась таблица `oauth_tokens` и в ней сохранены рабочие токены amoCRM.
- Проведите тестовый запуск `php bin/fetch_new.php` вручную — он должен завершиться без ошибок и создать сделки по новым заказам.
- Настройте задания cron и убедитесь, что запросы к `public/cron.php` возвращают `OK`. После этого интеграция готова к запуску в продакшен.

## Cron

- **Рекомендуемый способ**: под Supervisor/systemd запустите один процесс, который крутит оба задания и сам следит за интервалами:

  ```bash
  php /путь/к/проекту/bin/scheduler.php --loop
  ```

  Скрипт блокирует файл `storage/cron.lock` через `flock`, поэтому параллельный запуск второй копии не произойдёт. Это можно использовать как health-check: если планировщик удерживает блокировку, то очередной запуск мгновенно завершается без работы, а значит накладок и «двойной» обработки заказов не будет.

- **Фолбэк для shared-хостингов**: раз в минуту дергайте `php /путь/к/проекту/bin/scheduler.php --once` в cron (`* * * * *`). Планировщик отметит время последнего запуска в таблице `settings` и выполнит каждое задание только тогда, когда подошёл его интервал (fetch — каждые 60 сек, reconcile — каждые 10 минут).

- При необходимости можно использовать алиас `--daemon` вместо `--loop`.

- Чтобы получить готовые абсолютные пути и рекомендуемые команды cron, выполните:

  ```bash
  php /путь/к/проекту/bin/cron_paths.php
  ```

## Как это работает (кратко)

- **Kaspi:** `GET /orders` постранично (до 100 на страницу) от водяного знака `creationDate >= watermark`, далее `GET /orders/{id}/entries` для состава.  
- **amoCRM:** поиск контакта `GET /api/v4/contacts?query=+<phone>`, создание `POST /api/v4/contacts`; сделки пачками `POST /api/v4/leads`; привязка товаров `POST /api/v4/leads/{lead_id}/link`; заметка‑сводка.  
- Соблюдаем **лимит 7 rps** на интеграцию; клиент применяет троттлинг.

## Безопасность

- Не храните `.env` в публичной папке.  
- Меняйте `CRON_SECRET`.  
- Ограничивайте доступ к `/public/*` через случайный путь или Basic Auth.

## Примечание

- Для корректной работы каталожных полей (SKU/PRICE) создайте соответствующие поля в каталоге amoCRM и при необходимости адаптируйте код.
